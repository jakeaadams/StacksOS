{
	# StacksOS reverse proxy (Caddy)
	# - Terminates TLS (uses an internal CA by default)
	# - Enables gzip/zstd
	#
	# Set STACKSOS_HOST to a hostname or LAN IP (example: 192.168.1.233).
}

{$STACKSOS_HOST:stacksos.lan} {
	# Avoid binding on tailscale0 so Tailscale Serve can use :443 on the
	# node's 100.x address / ts.net hostname.
	#
	# On the StacksOS host, set STACKSOS_BIND=192.168.1.233 (or your LAN IP).
	bind {$STACKSOS_BIND:0.0.0.0}

	tls internal

	encode zstd gzip

	# Convenience: allow clients to download the public Root CA cert for trust
	# store installation (removes browser warnings once trusted).
	@ca path /caddy-internal-root.crt
	handle @ca {
		header Content-Disposition "attachment; filename=caddy-internal-root.crt"
		header Cache-Control "no-store"
		root * /etc/caddy/pki
		file_server
	}

	# Cache immutable Next.js static chunks aggressively.
	@static path /_next/static/*
	header @static Cache-Control "public, max-age=31536000, immutable"

	# Preserve the original request host/scheme so Next.js can generate correct
	# absolute URLs (e.g., CSP report endpoints) behind the proxy.
	reverse_proxy 127.0.0.1:3000 {
		header_up Host {host}
	}
}
