# StacksOS Execution Backlog (P0/P1/P2)

Date: 2026-01-25

This is the execution backlog derived from `docs/StacksOS-Master-PRD.md`.

Legend:
- AC = acceptance criteria
- DoD = definition of done

Global DoD (applies to every item):
- No dead UI (no buttons/links that do nothing).
- No fake saves: if the UI says it changed state, Evergreen state is changed (or queued with offline semantics).
- Accessibility: keyboard-only path exists for the workflow.
- Audit: sensitive actions emit an audit event.

---

## How To Use This Backlog (for Codex agents)

Rules:
- Work only in `/home/jake/projects/stacksos` on the `stacksos` VM.
- Do not create placeholder UI. If it is not end-to-end real, hide it behind `featureFlags`.
- Every "partial" item must have an explicit checklist of what remains.
- Keep `./audit/run_all.sh` green.

---

## Milestones (Ship Gates)

### Milestone 1: "Circ Desk Demo"
Goal: a librarian can work a full circulation desk shift using StacksOS for checkout/checkin/holds/bills.

Includes:
- P0-1, P0-2 (in strict mode), P0-3a..P0-3d, P0-3i, P0-9a

Ship when:
- All Milestone 1 items are **DONE** and `./audit/run_all.sh` passes.

### Milestone 2: "Full Staff Client"
Goal: all core staff modules (patrons + cataloging + acq + serials + reports) are end-to-end functional.

Includes:
- P0-4, P0-5, P0-6, P0-7, P0-8, P0-10

Ship when:
- Every sidebar route is either fully implemented OR hidden.
- Every module has real demo data in the sandbox (no empty screens without explanation).

### Milestone 3: "Pilot Ready"
Goal: a real library could run StacksOS for a week (operational trust).

Includes:
- P0-9b..P0-9g

Ship when:
- E2E tests exist for top workflows.
- Perf budgets are measured and enforced.
- Runbook exists and a non-dev can restart prod.

---

## Status Snapshot (as of 2026-01-25)

Implemented foundations:
- Staff shell + shared UI system: **DONE**
- Auth + workstation auto-register per device+branch: **DONE**
- Structured logging (`src/lib/logger.ts`) + file audit log (`.logs/audit.log`): **DONE**
- Automated audits exist (UI/API/workflow + run_all + repo inventory): **DONE**

In progress:
- Circulation hardening (overrides, receipts, routing slips, refunds, offline conflict resolution): **PARTIAL**
- Cataloging depth (diff view, Z39.50 import, MARC import): **PARTIAL**
- Acq/Serials actions: **PARTIAL** (read/list views + setup-required UX; real actions still needed)
- Reporting exports + scheduled reports: **PARTIAL/MISSING**

---

## P0: Pilot-ready staff client (Evergreen-backed)

### P0-0: Staff shell + UX foundation

Status: DONE

Done checklist:
- [x] Shared layout primitives (`PageContainer`, `PageHeader`, `PageContent`)
- [x] Shared loading/error/empty states
- [x] Shared `DataTable` patterns
- [x] Sidebar + top-nav shell
- [x] Command palette (`Cmd/Ctrl+K`)
- [x] Keyboard shortcuts registry (F-keys)

---

### P0-1: Auth + workstation + session UX

Status: DONE

Done checklist:
- [x] Login at `/login`
- [x] Evergreen auth token stored as httpOnly cookie
- [x] Workstation auto-register per device + branch (if permitted)
- [x] Session check endpoint
- [x] Logout

AC:
- First login on a new device takes <= 1 minute and is self-explanatory.

---

### P0-2: RBAC + audit logging (defense in depth)

Status: PARTIAL

Reason: implementation exists, but strict enforcement must be validated and enabled for pilot.

Checklist:
- [x] RBAC helper exists (`src/lib/permissions.ts`)
- [x] Audit logging exists (`src/lib/audit.ts`)
- [ ] Define/verify the StacksOS permission taxonomy (maps to Evergreen permissions)
- [x] Ensure every mutation endpoint calls `requirePermissions([...])`
- [ ] Set `STACKSOS_RBAC_MODE=strict` in production runbook
- [ ] Add "permission denied" UX that is staff-friendly (no cryptic errors)

AC:
- Every write/mutation endpoint requires an explicit permission.
- Audit logs include actor, org, workstation, requestId, outcome.

---

### P0-3: Circulation desk (win-or-die)

Status: PARTIAL

#### P0-3a: Checkout

Checklist:
- [x] Patron lookup (barcode/name)
- [x] Item checkout (Evergreen-backed)
- [x] Override handling (permissioned + audited)
- [x] Policy explainability UI (what policy blocked; what override allowed; who can override)
- [x] Receipt printing (minimum: printable HTML; later: email/SMS)
- [ ] Bulk/rapid scan throughput hardening (50 items/min sustained on LAN)

AC:
- Scan-first throughput: 50 items/min sustained on LAN.
- Exceptions are explainable, overrideable (if allowed), and audited.

#### P0-3b: Checkin

Checklist:
- [x] Scan + checkin (Evergreen-backed)
- [ ] Routing decisions are clear (hold shelf vs transit vs reshelve)
- [ ] Slip printing (routing/hold slips) at minimum: printable HTML
- [ ] Bookdrop / bulk checkin mode (one-keystroke mode for rapid returns)

AC:
- Scan -> routing decision <= 250ms perceived.

#### P0-3c: Holds management

Checklist:
- [x] Patron holds list
- [x] Title holds list
- [x] Pull list
- [x] Shelf list
- [x] Freeze/thaw/cancel/change pickup (as supported)
- [ ] Holds shelf workflow polish (capture -> print slip -> update status)

AC:
- All hold actions are audited.
- Title holds can be reached directly from catalog search results.

#### P0-3d: Bills & payments

Checklist:
- [x] View bills
- [x] Post payments
- [ ] Refund workflows (must exist for pilots; permissioned + audited)
- [ ] Receipts (printable)

AC:
- Payments/refunds update Evergreen state and are audited.

#### P0-3e: Lost / missing / damaged

Checklist:
- [x] UI present
- [ ] Verify every state change is a real Evergreen mutation
- [ ] Ensure billing integration is correct and explainable

AC:
- All status changes are audited.

#### P0-3f: Claims

Checklist:
- [x] UI present
- [ ] Verify claims returned + claims never checked out are real Evergreen actions

AC:
- All claim actions are audited.

#### P0-3g: In-house use

Checklist:
- [x] UI present
- [ ] Session-based scanning uses real Evergreen / reporting semantics
- [ ] Export/report is real (no dead export button)

AC:
- No dead export actions.

#### P0-3h: Offline circulation

Checklist:
- [x] Offline scaffolding present
- [ ] Durable local queue (store-and-forward)
- [ ] Pre-download block lists/policies
- [ ] Upload transactions
- [ ] Conflict resolution UI

AC:
- Offline transactions are durable and replayable.
- Upload is idempotent.

#### P0-3i: Error recovery + session resilience

Checklist:
- [x] Expired session mid-workflow -> redirect to `/login` with return URL
- [x] Evergreen unreachable -> clear degraded-mode banner + offline prompt
- [ ] Timeouts -> safe retry UX with idempotency
- [ ] 401 handling for pages that use raw fetch (migrate critical pages to `useApi`/`useMutation` or a shared client wrapper)

AC:
- Staff is never stuck in an unexplained broken state.

---

### P0-4: Patrons

Status: PARTIAL

#### P0-4a: Patron search + record

Checklist:
- [x] Search by name/barcode/email/phone
- [x] View key stats and blocks
- [ ] Deep links (history, checkouts, holds, bills) are correct

#### P0-4b: Patron registration

Checklist:
- [x] Create patron (Evergreen-backed)
- [ ] Barcode strategy is tenant-configurable (keep imported barcodes; do not force re-barcode)
- [ ] Field validation errors are human-readable

#### P0-4c: Patron edit / blocks / notes

Checklist:
- [ ] Edit core fields (permissioned)
- [ ] Blocks/penalties UX
- [ ] Notes/alerts UX

---

### P0-5: Cataloging & metadata

Status: PARTIAL

#### P0-5a: Catalog search

Checklist:
- [x] Search works (Evergreen-backed)
- [ ] Filters/search types are correctly translated (title/author/isbn/etc.)
- [ ] Deep links into MARC editor, holdings, item status

#### P0-5b: MARC editor

Checklist:
- [x] Load MARCXML
- [x] Save MARCXML
- [ ] Diff view (before/after)
- [ ] Validation of required fields with explainable errors

#### P0-5c: Z39.50 search + import

Checklist:
- [ ] Evergreen Z39.50 targets configuration surfaced as "setup required" UX
- [ ] Real search + import creates Evergreen bib

#### P0-5d: MARC import

Checklist:
- [ ] Import MARC with preview
- [ ] De-dupe / overlay rules (at least basic)

#### P0-5e: Authority search

Checklist:
- [x] View-only search (acceptable in P0)

#### P0-5f: Holdings / item status

Checklist:
- [x] Holdings view exists
- [ ] Item status view includes circ history endpoint + UI

---

### P0-6: Acquisitions

Status: PARTIAL

Goal: real actions, not just lists.

Checklist:
- [x] Vendors list
- [x] Funds list
- [x] Purchase orders list
- [x] Invoices list
- [ ] Receiving actions (real): receive, partial receive, cancel/claim, mark damaged
- [ ] Permissioned actions + audit events
- [ ] "Setup required" UX explains what Evergreen config is missing

---

### P0-7: Serials

Status: PARTIAL

Checklist:
- [x] Subscriptions list
- [x] Routing list
- [ ] Claims workflow (view-only acceptable for P0, but no dead buttons)
- [ ] "Setup required" UX

---

### P0-8: Reporting

Status: PARTIAL

Checklist:
- [x] Dashboards (basic)
- [ ] CSV export (async for large datasets)
- [ ] Scheduled reports (feature-flagged until real)

---

### P0-9: Quality gates (world-class reliability)

Status: PARTIAL

#### P0-9a: Automated audits (keep green)

Checklist:
- [x] UI audit script exists
- [x] API audit script exists
- [x] Workflow QA script exists
- [x] Single wrapper: `./audit/run_all.sh` (one command)
- [x] Repo inventory report (pages/routes/nav coverage)

AC:
- One command validates: no dead UI + adapter health + core workflow smoke.

#### P0-9b: E2E tests (Playwright)

Checklist:
- [ ] Add Playwright
- [ ] Top workflows covered end-to-end

#### P0-9c: Contract tests (Evergreen adapter)

Checklist:
- [ ] Schema/invariants per endpoint
- [ ] Fixtures for edge cases (policy blocks, overrides)

#### P0-9d: Performance budgets

Checklist:
- [ ] Perf harness reports p50/p95
- [ ] Budgets enforced for checkout/checkin/holds/search

#### P0-9e: Type safety hardening (reduce `any`)

Checklist:
- [ ] Reduce `any` in adapter routes/shared libs
- [ ] Add Zod validation at boundaries

#### P0-9f: Structured logging + request IDs

Checklist:
- [x] Structured logger exists (`src/lib/logger.ts`)
- [x] Audit log exists (`src/lib/audit.ts`)
- [ ] Ensure every API route propagates `requestId` into audit + logs
- [ ] Enforce "no console.*" (already true in `src/`)

#### P0-9g: Production runbook (pilot readiness)

Checklist:
- [ ] Dev vs prod commands documented
- [ ] Process manager (systemd/pm2) documented
- [ ] Backup/restore and Evergreen dependency notes

---

### P0-10: Sandbox data + Evergreen config seeding

Status: PARTIAL

Reason: multiple modules show empty-data signals because Evergreen is not configured (funds/vendors/booking/serials/authority/etc.).

Checklist:
- [ ] Seed patrons (10+ with varied profiles)
- [ ] Seed items/bibs (100+)
- [ ] Acq: create 1 vendor, 1 fund, 1 PO
- [ ] Serials: create 1 subscription + routing list
- [ ] Booking: create 1 resource type + 1 resource
- [ ] Authority: configure search target (if applicable)

AC:
- Every StacksOS module shows real data or a clear "setup required" guide.

---

## P1: Competitive parity + SaaS experience

Themes:
- SSO + MFA
- notifications
- OPAC/patron app
- multi-branch admin/policies
- integrations (SIP2/NCIP/payment/SMS/printing)

Epics:
- P1-0: SaaS control plane (tenant provisioning, upgrades, backups)
- P1-1: Notifications center (email/SMS templates + preferences)
- P1-2: OPAC / patron experience v1
- P1-3: Advanced acquisitions (EDI, fund splits, claims)
- P1-4: Advanced serials (predictive patterns, routing slips)
- P1-5: Admin policy center (calendars, circ rules, pickup rules)
- P1-6: Security hardening (MFA, session mgmt, IP allowlists)
- P1-7: Implementation + training system (migration playbooks, in-app walkthroughs)
- P1-8: Support + ops readiness (status page, support intake, release notes)

---

## P2: World-class differentiators (AI + collaboration)

AI principles:
- auditable
- reversible
- permissioned
- privacy-safe

Epics:
- P2-0: AI cataloging assistant (subjects/summaries with provenance)
- P2-1: AI circulation assistant (risk + policy explanation)
- P2-2: AI discovery (semantic search + recommendations with opt-in)
- P2-3: AI analytics (narratives + drill-down)
- P2-4: Collaboration UX (presence, conflict resolution, tasking)

